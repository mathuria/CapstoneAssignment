node("master"){
    stage("Clone source code"){
        git branch: 'main', url: 'https://github.com/mathuria/CapstoneAssignment.git'
    }
    stage("Build docker image"){
        sh 'sudo docker build -t app_image_'+env.BUILD_NUMBER + " ."
    }
    stage("Run docker image"){
        sh 'sudo docker run -dp 5000:5000 --net=host app_image_'+env.BUILD_NUMBER
    }
    stage("Run test scripts"){
        sh 'python rest_tester.py'
    }
    stage("Stop docker image"){
        sh 'sudo docker container kill $(sudo docker ps -q)'
    }
    stage("Push image to dockerhub"){
        withDockerRegistry([ credentialsId: "docker", url: "https://registry.hub.docker.com/aishwaryamathuria/myassessmentimage" ]) {
          sh 'docker push app_image_' + env.BUILD_NUMBER + ":latest"
       }
    }
}
